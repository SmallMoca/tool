# 项目构建工具替换为 vite 踩坑

## why 为什么使用 vite 作为开发工具？

随着项目迭代，项目模块和引入的依赖原来越多，出现了启动开发环境服务慢的问题、热更新、热替换慢的问题。

## vite 为什么快？

**项目启动过程**

- 语言优势，vite 使用 esbuild 预构建依赖，esbuild 使用 go 编写，对处理 cpu 密集型的任务有天然的优势。
- 源码部分，vite 不会主动去编译转换源码部分的代码。我们访问项目的某个页面的时候并不需要所有的源码，所以 vite 只需要在浏览器请求所需的源码的时候去按需转换提供所需的代码，基于 esm。这相当于让浏览器接管了部分打包工作。
- vite 还利用了 http 头来加速热更新的的过程，源码模块 会根据 304 进行协商缓存，依赖模块 直接强缓存。

## 为什么生产环境仍要打包？

- 不进行打包在生产环境 ，会因为项目引入的模块过多导致网络往返时间增多
- 生产环境代码需要做 chunk 分割做更好的缓存
- 我们生产环境的代码需要 three-shking 等

## vite 提供的功能

### vite 对 npm 依赖的解析和预构建

原生 esm 导入不支持 我们源码中的裸模块导入

```ts
import { useState } from 'react';
```

这种代码 直接在浏览器使用会直接报错。
vite 对这种模块处理是；

- 预构建，将 commonjs/umd 转换为 esm 模块，这个预构建的过程使用 esbuild 执行，
- 重写浏览器支持的模块路径 例如 `import React from 'react';` 会重写为 `import __vite__cjsImport7_react from "/node_modules/.vite/deps/react.js?v=8f076fcd";`
- npm 模块会被强缓存
